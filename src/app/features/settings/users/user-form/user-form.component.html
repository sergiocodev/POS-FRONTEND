<div class="user-form-container">
    <p-toast></p-toast>

    <div *ngIf="isLoading()" class="text-center py-5">
        <p-progressSpinner ariaLabel="loading"></p-progressSpinner>
    </div>

    <ng-container *ngIf="!isLoading()">
        <div class="form-header">
            <div class="header-content">
                <h2>{{ isEditMode() ? 'Editar' : 'Nuevo' }} Usuario</h2>
                <p>Complete la información detallada para la gestión del perfil.</p>
            </div>
        </div>

        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
            <div class="grid">
                <!-- Columna Izquierda: Información Principal -->
                <div class="col-12 lg:col-7">
                    <div class="glass-card mb-4 min-h-full">
                        <p-card header="Información de Cuenta">
                            <div class="section-subtitle">
                                <i class="pi pi-user-edit"></i>
                                <span>Credenciales y datos personales obligatorios</span>
                            </div>

                            <div class="grid">

                                <div class="col-12 field" *ngIf="!isEditMode()">
                                    <label>Número de documento</label>
                                    <div class="document-search-group">
                                        <input type="text" pInputText formControlName="document"
                                            placeholder="N° de Documento (DNI/CEX)" class="w-full" />
                                        <p-button icon="pi pi-search" severity="info" type="button" class="search-btn"
                                            (onClick)="searchDocument()" [loading]="isSearching()"></p-button>
                                    </div>
                                    <small class="text-muted">Use la búsqueda para autocompletar datos</small>
                                </div>

                                <div class="col-12 field">
                                    <label>Nombre Completo <span class="text-danger">*</span></label>
                                    <span class="p-input-icon-left w-full">
                                        <i class="pi pi-id-card"></i>
                                        <input type="text" pInputText formControlName="fullName"
                                            placeholder="Ej: Juan Pérez García" />
                                    </span>
                                    <small *ngIf="f['fullName']?.invalid && f['fullName']?.touched" class="text-danger">
                                        El nombre es requerido para el registro
                                    </small>
                                </div>

                                <div class="col-12 md:col-6 field">
                                    <label>Email <span class="text-danger">*</span></label>
                                    <span class="p-input-icon-left w-full">
                                        <i class="pi pi-envelope"></i>
                                        <input type="email" pInputText formControlName="email"
                                            placeholder="correo@corporativo.com" />
                                    </span>
                                    <small *ngIf="f['email']?.invalid && f['email']?.touched" class="text-danger">
                                        {{ f['email']?.errors?.['required'] ? 'El email es requerido' : 'Email inválido'
                                        }}
                                    </small>
                                </div>

                                <div class="col-12 md:col-6 field">
                                    <label>Usuario <span class="text-danger">*</span></label>
                                    <span class="p-input-icon-left w-full">
                                        <i class="pi pi-user"></i>
                                        <input type="text" pInputText formControlName="username"
                                            placeholder="Identificador de ingreso" />
                                    </span>
                                    <small *ngIf="f['username']?.invalid && f['username']?.touched" class="text-danger">
                                        {{ f['username']?.errors?.['required'] ? 'El usuario es requerido' : 'Mínimo 3
                                        caracteres' }}
                                    </small>
                                </div>

                                <div class="col-12 field">
                                    <label>Seguridad</label>
                                    <div class="grid align-items-center">
                                        <div class="col-12 md:col-8">
                                            <p-password formControlName="password" [toggleMask]="true"
                                                [feedback]="false" placeholder="Contraseña segura (min 8 car.)"
                                                styleClass="w-full" [inputStyleClass]="'w-full'"></p-password>
                                            <small *ngIf="isEditMode()" class="text-muted block mt-1">
                                                (dejar vacío para no cambiar)
                                            </small>
                                            <small *ngIf="f['password']?.invalid && f['password']?.touched"
                                                class="text-danger block mt-1">
                                                {{ f['password']?.errors?.['required'] ? 'La contraseña es obligatoria'
                                                :
                                                'Mínimo 8 caracteres' }}
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- profilePicture Field -->
                                <div class="col-12 field border-top-1 surface-border pt-4 mt-4">
                                    <label class="font-bold text-primary mb-3 block">Foto de Perfil</label>
                                    <div class="grid align-items-center">
                                        <div class="col-12 md:col-8">
                                            <div class="flex gap-2 mb-2">
                                                <span class="p-input-icon-left flex-grow-1">
                                                    <i class="pi pi-image text-primary"></i>
                                                    <input type="text" pInputText formControlName="profilePicture"
                                                        placeholder="/uploads/usuarios/nombre.png" class="w-full" />
                                                </span>
                                                <input type="file" #fileInput hidden (change)="onFileSelected($event)"
                                                    accept="image/*">
                                                <p-button icon="pi pi-upload" (onClick)="fileInput.click()"
                                                    [loading]="isSaving()" severity="info" pTooltip="Subir Foto"
                                                    tooltipPosition="top"></p-button>
                                            </div>
                                            <small class="text-muted block">Ingrese la ruta o use el botón para subir
                                                una
                                                foto (ej: /uploads/usuarios/admin.png)</small>
                                        </div>
                                        <div class="col-12 md:col-4 flex justify-content-center">
                                            <div class="avatar-preview-container border-2 border-circle surface-border surface-50 flex align-items-center justify-content-center overflow-hidden"
                                                style="width: 100px; height: 100px; transition: all 0.3s ease;">
                                                @if (userForm.get('profilePicture')?.value && !imageError()) {
                                                <img [src]="userForm.get('profilePicture')?.value" alt="Preview"
                                                    class="preview-image" (error)="imageError.set(true)">
                                                } @else {
                                                <div class="flex flex-column align-items-center text-muted">
                                                    <i class="pi pi-user text-3xl mb-1"></i>
                                                    <span class="text-xs">Sin foto</span>
                                                </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </p-card>
                    </div>
                </div>

                <!-- Columna Derecha: Roles y Configuración -->
                <div class="col-12 lg:col-5">
                    <div class="glass-card min-h-full">
                        <p-card header="Nivel de Acceso">
                            <div class="section-subtitle">
                                <i class="pi pi-shield"></i>
                                <span>Permisos y privilegios del sistema</span>
                            </div>

                            <div class="roles-grid">
                                <div *ngIf="roles().length === 0" class="text-center py-4 border-round-xl surface-50">
                                    <i class="pi pi-exclamation-circle text-2xl text-muted mb-2"></i>
                                    <p class="text-muted m-0">No se encontraron roles activos</p>
                                </div>

                                <div *ngFor="let role of roles()" class="role-card"
                                    [class.selected]="isRoleSelected(role.id)" (click)="toggleRole(role.id)">
                                    <div class="role-icon-box">
                                        <i [class]="isRoleSelected(role.id) ? 'pi pi-check' : 'pi pi-lock'"></i>
                                    </div>
                                    <div class="role-details">
                                        <span class="role-name">{{ role.name }}</span>
                                        <span class="role-desc">{{ role.description || 'Sin descripción asignada'
                                            }}</span>
                                    </div>
                                    <p-checkbox [binary]="true" [ngModel]="isRoleSelected(role.id)"
                                        [ngModelOptions]="{standalone: true}"
                                        (click)="$event.stopPropagation()"></p-checkbox>
                                </div>
                            </div>

                            <div class="mt-3 p-3 surface-50 border-round-xl" *ngIf="selectedRoles().length > 0">
                                <small
                                    class="text-muted d-block mb-2 uppercase font-bold text-xs">Seleccionados:</small>
                                <div class="flex flex-wrap gap-2">
                                    <ng-container *ngFor="let role of roles()">
                                        <p-chip *ngIf="isRoleSelected(role.id)" [style]="{'font-size': '12px'}"
                                            [label]="role.name" icon="pi pi-tag"></p-chip>
                                    </ng-container>
                                </div>
                            </div>
                        </p-card>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <p-button label="Descartar" icon="pi pi-arrow-left" (onClick)="cancel()" severity="secondary"
                    [text]="true" [disabled]="isSaving()" class="btn-action"></p-button>

                <p-button [label]="isEditMode() ? 'Guardar Cambios' : 'Registrar Usuario'" icon="pi pi-check-circle"
                    type="submit" [loading]="isSaving()" severity="primary" [disabled]="isSaving()"
                    class="btn-action"></p-button>
            </div>
        </form>
    </ng-container>
</div>
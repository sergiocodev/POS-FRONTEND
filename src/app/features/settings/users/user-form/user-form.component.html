<div class="user-form animate-fade-in p-4">

    <div *ngIf="isLoading()" class="d-flex justify-content-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <ng-container *ngIf="!isLoading()">
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
            <div class="row g-4">

                <div class="col-12 col-lg-7">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body px-4 pb-4">
                            <div class="row g-3">

                                <div class="col-12" *ngIf="!isEditMode()">
                                    <label class="form-label fw-semibold">Número de documento</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" formControlName="document"
                                            placeholder="N° de Documento (DNI/CEX)">
                                        <button class="btn btn-info text-white" type="button" (click)="searchDocument()"
                                            [disabled]="isSearching()">
                                            <span *ngIf="isSearching()"
                                                class="spinner-border spinner-border-sm me-1"></span>
                                            <i *ngIf="!isSearching()" class="bi bi-search"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Use la búsqueda para autocompletar datos</div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-semibold">Nombre Completo <span
                                            class="text-danger">*</span></label>
                                    <div class="input-group has-validation">
                                        <span class="input-group-text bg-light"><i class="bi bi-card-text"></i></span>
                                        <input type="text" class="form-control" formControlName="fullName"
                                            placeholder="Ej: Juan Pérez García"
                                            [class.is-invalid]="f['fullName'].invalid && f['fullName'].touched">
                                        <div class="invalid-feedback">
                                            El nombre es requerido para el registro.
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label fw-semibold">Email <span
                                            class="text-danger">*</span></label>
                                    <div class="input-group has-validation">
                                        <span class="input-group-text bg-light"><i class="bi bi-envelope"></i></span>
                                        <input type="email" class="form-control" formControlName="email"
                                            placeholder="correo@corporativo.com"
                                            [class.is-invalid]="f['email'].invalid && f['email'].touched">
                                        <div class="invalid-feedback">
                                            {{ f['email'].errors?.['required'] ? 'El email es requerido' : 'Email
                                            inválido' }}
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">Usuario <span
                                            class="text-danger">*</span></label>
                                    <div class="input-group has-validation">
                                        <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                                        <input type="text" class="form-control" formControlName="username"
                                            placeholder="Identificador"
                                            [class.is-invalid]="f['username'].invalid && f['username'].touched">
                                        <div class="invalid-feedback">
                                            {{ f['username'].errors?.['required'] ? 'Requerido' : 'Mínimo 3 caracteres'
                                            }}
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-semibold">Contraseña</label>

                                    <div class="input-group has-validation">
                                        <input [type]="showPassword() ? 'text' : 'password'" class="form-control"
                                            formControlName="password" placeholder="Mín. 8 carácteres"
                                            [class.is-invalid]="f['password'].invalid && f['password'].touched">

                                        <button class="btn btn-outline-secondary" type="button"
                                            (click)="togglePassword()">
                                            <i class="bi" [class]="showPassword() ? 'bi-eye-slash' : 'bi-eye'"></i>
                                        </button>

                                        <div class="invalid-feedback">
                                            {{ f['password'].errors?.['required'] ? 'Obligatoria' : 'Mínimo 8
                                            caracteres' }}
                                        </div>
                                    </div>

                                    <div *ngIf="isEditMode()" class="form-text mt-1">
                                        (dejar vacío para no cambiar)
                                    </div>
                                </div>


                                <div class="col-12 border-top pt-4 mt-2">
                                    <label class="form-label fw-bold text-primary mb-3">Foto de Perfil</label>
                                    <div class="row align-items-center">
                                        <div class="col-12 col-md-8 mb-3 mb-md-0">
                                            <div class="input-group mb-2">
                                                <input type="text" class="form-control"
                                                    formControlName="profilePicture">
                                                <input type="file" #fileInput hidden (change)="onFileSelected($event)"
                                                    accept="image/*">
                                                <button class="btn btn-outline-primary" type="button"
                                                    (click)="fileInput.click()" [disabled]="isSaving()"
                                                    title="Subir Foto">
                                                    <i class="bi bi-image"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">Suba una imagen.</small>
                                        </div>
                                        <div class="col-12 col-md-4 d-flex justify-content-center">
                                            <div class="avatar-preview rounded-circle border d-flex align-items-center justify-content-center overflow-hidden bg-light"
                                                style="width: 100px; height: 100px;">
                                                <img *ngIf="userForm.get('profilePicture')?.value && !imageError()"
                                                    [src]="userForm.get('profilePicture')?.value"
                                                    class="w-100 h-100 object-fit-cover" (error)="imageError.set(true)"
                                                    alt="Preview">
                                                <div *ngIf="!userForm.get('profilePicture')?.value || imageError()"
                                                    class="text-center text-muted">
                                                    <i class="bi bi-person fs-1"></i>
                                                    <div style="font-size: 0.7rem;">Sin foto</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12 col-lg-5">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body px-4 pb-4">
                            <div class="roles-container custom-scrollbar mb-3">
                                <div *ngIf="roles().length === 0" class="text-center py-4 bg-light rounded">
                                    <i class="bi bi-exclamation-circle fs-3 text-muted mb-2 d-block"></i>
                                    <span class="text-muted">No se encontraron roles activos</span>
                                </div>

                                <div *ngFor="let role of roles()"
                                    class="role-item p-3 mb-2 rounded border cursor-pointer position-relative d-flex align-items-center gap-3"
                                    [class.border-primary]="isRoleSelected(role.id)"
                                    [class.bg-primary-subtle]="isRoleSelected(role.id)" (click)="toggleRole(role.id)">

                                    <div class="role-icon d-flex align-items-center justify-content-center rounded bg-white border flex-shrink-0"
                                        style="width: 40px; height: 40px;">
                                        <i class="bi fs-4"
                                            [ngClass]="isRoleSelected(role.id) ? 'bi-check-lg text-primary' : 'bi-lock text-muted'"></i>
                                    </div>

                                    <div class="flex-grow-1">
                                        <div class="fw-bold text-dark">{{ role.name }}</div>
                                        <div class="small text-muted lh-sm">{{ role.description || 'Sin descripción' }}
                                        </div>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" [checked]="isRoleSelected(role.id)"
                                            (click)="$event.stopPropagation()" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="p-3 bg-light rounded" *ngIf="selectedRoles().length > 0">
                                <small class="text-uppercase fw-bold text-muted d-block mb-2"
                                    style="font-size: 0.75rem;">Seleccionado:</small>
                                <div class="d-flex flex-wrap gap-2">
                                    <ng-container *ngFor="let role of roles()">
                                        <span *ngIf="isRoleSelected(role.id)"
                                            class="badge bg-primary rounded-pill fw-normal">
                                            <i class="bi bi-tag-fill me-1"></i> {{ role.name }}
                                        </span>
                                    </ng-container>
                                </div>
                            </div>

                            <div *ngIf="f['roleIds'].invalid && f['roleIds'].touched" class="text-danger small mt-2">
                                <i class="bi bi-exclamation-circle me-1"></i> Debe seleccionar al menos un rol.
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="card border-0 mt-4 shadow-sm">
                <div class="card-body d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-secondary" (click)="cancel()" [disabled]="isSaving()">
                        <i class="bi bi-arrow-left me-1"></i> Descartar
                    </button>
                    <button type="submit" class="btn btn-primary px-4" [disabled]="isSaving()">
                        <span *ngIf="isSaving()" class="spinner-border spinner-border-sm me-1" role="status"
                            aria-hidden="true"></span>
                        <i *ngIf="!isSaving()" class="bi bi-check-circle me-1"></i>
                        {{ isEditMode() ? 'Guardar Cambios' : 'Registrar Usuario' }}
                    </button>
                </div>
            </div>

        </form>
    </ng-container>
</div>
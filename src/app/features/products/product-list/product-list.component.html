<app-module-header title="Gestión de Productos" iconClass="bi bi-box-seam"></app-module-header>

<div class="container-fluid py-4">

    <div class="d-flex justify-content-end mb-4">
        <button class="btn btn-primary" (click)="onNew()">
            <i class="bi bi-plus-lg me-1"></i> Nuevo Producto
        </button>
    </div>

    <div class="row mb-3" *ngIf="errorMessage()">
        <div class="col-12">
            <div class="alert alert-danger alert-dismissible fade show">
                {{ errorMessage() }}
                <button type="button" class="btn-close" (click)="errorMessage.set('')"></button>
            </div>
        </div>
    </div>

    <app-table-filter [(searchQuery)]="searchTerm" [placeholder]="'Buscar por nombre, código...'"
        [disableClear]="!searchTerm() && selectedCategory() === null && selectedBrand() === null && selectedTherapeuticAction() === null"
        (clear)="resetFilters()">

        <div class="row g-2 w-100 mt-0">
            <div class="col-md-4">
                <label class="form-label fw-semibold small mb-1">Acción Terapéutica</label>
                <select class="form-select form-select-sm" [ngModel]="selectedTherapeuticAction()"
                    (ngModelChange)="selectedTherapeuticAction.set($event)">
                    <option [ngValue]="null">Todas</option>
                    <option *ngFor="let item of therapeuticActions()" [ngValue]="item.id">{{ item.name }}</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-semibold small mb-1">Categoría</label>
                <select class="form-select form-select-sm" [ngModel]="selectedCategory()"
                    (ngModelChange)="selectedCategory.set($event)">
                    <option [ngValue]="null">Todas</option>
                    <option *ngFor="let item of categories()" [ngValue]="item.id">{{ item.name }}</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-semibold small mb-1">Marca</label>
                <select class="form-select form-select-sm" [ngModel]="selectedBrand()"
                    (ngModelChange)="selectedBrand.set($event)">
                    <option [ngValue]="null">Todas</option>
                    <option *ngFor="let item of brands()" [ngValue]="item.id">{{ item.name }}</option>
                </select>
            </div>
        </div>

    </app-table-filter>

    <ng-template #codeTemplate let-row>
        <div class="d-flex flex-column" style="line-height: 1.2;">

            <small class="text-muted fw-semibold">
                {{ row.code }}
            </small>

            <small class="text-dark fw-bold" *ngIf="row.barcode">
                {{ row.barcode }}
            </small>

            <small class="text-info fw-bold" *ngIf="row.digemidCode">
                {{ row.digemidCode }}
            </small>

        </div>
    </ng-template>

    <ng-template #productInfoTemplate let-row>
        <div class="d-flex align-items-center py-2">

            <div class="me-3 border rounded bg-light d-flex align-items-center justify-content-center flex-shrink-0"
                style="width: 80px; height: 80px; overflow: hidden;">
                <img *ngIf="row.imageUrl" [src]="row.imageUrl" class="img-fluid w-100 h-100 object-fit-cover"
                    (error)="$any($event.target).style.display = 'none'">
                <i *ngIf="!row.imageUrl" class="bi bi-image text-muted fs-5"></i>
            </div>

            <div class="d-flex flex-column">
                <div class="fw-bold text-dark lh-sm">{{ row.tradeName }}</div>

                <div class="small lh-sm">
                    <span class="text-info fw-semibold" *ngIf="row.genericName">({{ row.genericName }})</span>
                    <span class="text-muted d-block text-truncate" style="max-width: 250px;">{{ row.description
                        }}</span>
                </div>

                <div class="d-flex flex-wrap gap-1 mt-1">
                    <span *ngFor="let badge of getProductBadges(row)" class="badge rounded-1 fw-normal"
                        [ngClass]="badge.class" style="font-size: 0.7rem;">
                        {{ badge.label }}
                    </span>
                </div>
            </div>
        </div>
    </ng-template>

    <div class="card shadow-sm border-0">

        <div *ngIf="isLoading()" class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3 text-muted">Cargando...</p>
        </div>

        <app-custom-table *ngIf="!isLoading()" [data]="filteredProducts()" [columns]="columns" [pageSize]="10"
            (onAction)="handleTableAction($event)" (onToggle)="handleTableToggle($event)">
        </app-custom-table>

    </div>
</div>

<!-- Modal Genérico para Producto -->
<app-modal-generic [title]="selectedProductId() ? 'Editar Producto' : 'Nuevo Producto'" [isVisible]="showProductModal()"
    (close)="onProductCancelled()" size="xl">
    <app-product-form *ngIf="showProductModal()" [idProduct]="selectedProductId()" [isModal]="true"
        (saved)="onProductSaved()" (cancelled)="onProductCancelled()">
    </app-product-form>
</app-modal-generic>